<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="jquery.js"></script>
  <script src="cncserver.client.api.js"></script>
  <script src="cncserver.client.commander.js"></script>
</head>

<body>
  <canvas id="imageCanvas" ></canvas>
  <input type="file" id="imageLoader" name="imageLoader">

  <script>
    $('#imageLoader').change(handleImage);
    var canvas = $('#imageCanvas')[0];
    var ctx = canvas.getContext('2d');


  function handleImage(e){
    var reader = new FileReader();
    reader.onload = function(event){
      var img = new Image();
      img.onload = function () {
        canvas.width = Math.max(img.height, Math.floor(100 / pixelSize.h));
        canvas.height = Math.max(img.width, Math.floor(100 / pixelSize.w));
        ctx.drawImage(img,0,0);
        drawImage(this);

        ctx.beginPath();
        ctx.moveTo(Math.floor(100 / pixelSize.w), 0);
        ctx.lineTo(Math.floor(100 / pixelSize.w), Math.floor(100 / pixelSize.h));
        ctx.lineTo(0, Math.floor(100 / pixelSize.h));
        ctx.strokeStyle = "red";
        ctx.stroke();
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  }

    // This is based off http://www.html5canvastutorials.com/advanced/html5-canvas-get-image-data-tutorial/
    var image_pixel_draw = [];

    function drawImage(imageObj) {
      image_pixel_draw = [];
      var canvas = document.getElementById('imageCanvas');
      var context = canvas.getContext('2d');
      var imageX = 0;
      var imageY = 0;
      var imageWidth = imageObj.width;
      var imageHeight = imageObj.height;

      // image_pixel_draw = Array(imageHeight);

      context.drawImage(imageObj, imageX, imageY);

      var imageData = context.getImageData(imageX, imageY, imageWidth, imageHeight);
      var data = imageData.data;

      var red = 0;
      // var green = 0;
      // var blue = 0;
      // var alpha = 0;

      // iterate over all pixels based on x and y coordinates
      for (var y = 0; y < imageHeight; y++) {
        // loop through each column
        image_pixel_draw[y] = []; // Initialize the second dimension of the array

        for (var x = 0; x < imageWidth; x++) {
          red = data[((imageWidth * y) + x) * 4];
          // green = data[((imageWidth * y) + x) * 4 + 1];
          // blue = data[((imageWidth * y) + x) * 4 + 2];
          // alpha = data[((imageWidth * y) + x) * 4 + 3];

          image_pixel_draw[y][x] = red <= 127 ? 1 : 0;
        }
      }
    }

    // var imageObj = new Image();
    // imageObj.onload = function () {
    //   drawImage(this);
    // };
    // imageObj.src = 'flowchart.png';

    cncserver.api.server = {
      domain: 'localhost',
      port: 4242,
      protocol: 'http',
      version: '1'
    };
    // Drawing params
    var pixelSize = {
      w: 0.18,   // Measured using penDotSizeTest for a Sharpie Pen Fine Point
      h: 0.24825 // Calculated based on WCB aspect ratio
    };

    var run = cncserver.cmd.run; // Command runner shortcut var

    function draw_points(points, offset) {
      var penPosition = 0; // Pen is up; 1 when pen is down
      run('up');

      for (var y in points) { // Go through each row
        for (var x in points[y]) { // Go through each column
          // Move to first/next position
          if (points[y][x] !== penPosition) {
            run('move', {x: offset.x + (pixelSize.w * x),
              y: offset.y + (pixelSize.h * y)});

            penPosition = points[y][x];
            if (points[y][x] === 1) {
              run('down');
            } else {
              run('up');
            }
          }
        }

        // Move for the last pixel and reset
        run('move', {x: offset.x + (pixelSize.w * (Number(x) + 1)),
          y: offset.y + (pixelSize.h * y)});
        run('up');
        penPosition = 0;
      }

      run('park'); // We're done!
    }

    function drawLine(start, stop) {
      run('move', start);
      run('down');
      run('move', stop);
      run('up');
    }

    function penDotSizeTest(location, length, width, resoultion) {
      drawLine(location, {x: location.x, y: location.y + length});
      drawLine(location, {x: location.x + width, y: location.y + length});

      for (var i = location.y; i < location.y + length; i += resoultion) {
        console.log(i, i - location.y);
        drawLine({x: location.x - 1, y: i}, {x: location.x - 0.5, y: i});
      }
    }

    // draw_points(data, {x: 10, y: 55});

    // Run this to draw the image.
    // draw_points(image_pixel_draw, {x: 30, y: 10});

    // Fun thing for testing:
    // function draw_random() {
    //   cncserver.api.pen.move({x: (Math.random() * 97) + 3, y: Math.random() * 100}, draw_random);
    // }
    // console.log("starting random");
    // draw_random();
  </script>
</body>

</html>
