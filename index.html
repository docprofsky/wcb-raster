<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="jquery.js"></script>
  <script src="cncserver.client.api.js"></script>
  <script src="cncserver.client.commander.js"></script>
</head>

<body>
  <canvas id="imageCanvas" width="1000", height="1000"></canvas>

  <script>
    // This is based off http://www.html5canvastutorials.com/advanced/html5-canvas-get-image-data-tutorial/
    var image_pixel_draw = [];

    function drawImage(imageObj) {
      var canvas = document.getElementById('imageCanvas');
      var context = canvas.getContext('2d');
      var imageX = 0;
      var imageY = 0;
      var imageWidth = imageObj.width;
      var imageHeight = imageObj.height;

      // image_pixel_draw = Array(imageHeight);

      context.drawImage(imageObj, imageX, imageY);

      var imageData = context.getImageData(imageX, imageY, imageWidth, imageHeight);
      var data = imageData.data;

      var red = 0;
      var green = 0;
      var blue = 0;
      var alpha = 0;

      // iterate over all pixels
      // for(var i = 0, n = data.length; i < n; i += 4) {
      //   red = data[i];
      //   green = data[i + 1];
      //   blue = data[i + 2];
      //   alpha = data[i + 3];
      // }

      // iterate over all pixels based on x and y coordinates
      for(var y = 0; y < imageHeight; y++) {
        // loop through each column
        image_pixel_draw[y] = []; // Initialize the second dimension of the array

        for(var x = 0; x < imageWidth; x++) {
          red = data[((imageWidth * y) + x) * 4];
          green = data[((imageWidth * y) + x) * 4 + 1];
          blue = data[((imageWidth * y) + x) * 4 + 2];
          alpha = data[((imageWidth * y) + x) * 4 + 3];

          image_pixel_draw[y][x] = red <= 50 ? 1 : 0;
        }
      }
    }

    var imageObj = new Image();
    imageObj.crossOrigin = "anonymous";
    imageObj.onload = function() {
      drawImage(this);
    };
    imageObj.src = 'flowchart.png';
  </script>

  <script type="text/javascript">
  console.table(image_pixel_draw);

  cncserver.api.server = {
     domain: 'localhost',
     port: 4242,
     protocol: 'http',
     version: '1'
   };
   // Drawing params
   var pixelSize = {
     w: 0.15,
     h: 0.15
   };

   var run = cncserver.cmd.run; // Command runner shortcut var


  //  drawPos = [
  //    {x: 20, y: 20},
  //    {x: 20, y: 50},
  //    {x: 50, y: 50},
  //    {x: 50, y: 20},
  //    {x: 20, y: 20}
  //  ];
  //
  //  for(var i =0; i < drawPos.length; i++) {
  //    cncserver.api.pen.move(drawPos[i]);
  //    console.log(drawPos[i]);
  //  }
  //
  // //  cncserver.api.pen.move({x: 0, y: 0}, function () {cncserver.api.pen.move({x:50, y:50});console.log("part 2");});
  //  cncserver.api.pen.move({x: 0, y: 0});
  //
  //  cncserver.api.motors.unlock(function () {console.log("unlock");});

  var data = [
    [0,0,1,1,1,1,0,0,1,0],
    [1,1,1,1,1,1,0,0,0,1],
    [0,1,0,1,0,1,0,1,0,1],
    [1,1,0,0,0,1,1,0,0,1]
  ];

  //  for(i = 0; i < points.length; i++) {
  //     for(j = 0; j < points[i].length; j++) {
  //       if(points[i][j] === 1) {
  //           cncserver.api.pen.down();
  //         } else {
  //           cncserver.api.pen.up();
  //         }
  //       cncserver.api.pen.move({x: j+10, y: i+10});
  //     }
  //     cncserver.api.pen.up();
  // }

  // var line = 0;
  // draw_line(data[line], {x: 10, y: 28 + line}, 1, );
  // if(line >= data.length) {
  //   cncserver.api.pen.up();
  // } else {
  //   cncserver.api
  // }

  function draw_points(points, offset) {
    for (var y in points) { // Go through each row
      for (var x in points[y]) { // Go through each column
        // Move to first/next position
        run('move', {x: offset.x + (pixelSize.w * x), y: offset.y + (pixelSize.h * y)});

        if(points[y][x] === 1) {
          run('down');
        } else {
          run('up');
        }
      }

      // Move for the last pixel and reset
      run('move', {x: offset.x + (pixelSize.w * x +  1), y: offset.y + (pixelSize.h * y)});
      run('up');
    }

    run('park'); // We're done!
  }

  // draw_points(data, {x: 10, y: 55});

  // Run this to draw the image. This is less than nice to cncserver.
  // draw_points(image_pixel_draw, {x: 30, y: 10});

  // Fun thing for testing:
  //  function draw_random() {
  //    cncserver.api.pen.move({x: (Math.random() * 97) + 3, y: Math.random() * 100}, draw_random);
  //  }
  //  console.log("starting random");
  //  draw_random();
  </script>
</body>

</html>
